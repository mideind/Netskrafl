# docker-compose.local.yml - Run in Docker, connecting to host PostgreSQL and Redis
#
# Usage:
#   docker compose -f docker-compose.local.yml up --build
#
# Prerequisites:
#   1. PostgreSQL running on localhost:5432 with netskrafl_test database
#   2. Redis running on localhost:6379
#   3. GCP credentials at ./resources/Explo Development-414318fa79b8.json

services:

  app:
    build:
      context: .
      dockerfile: Dockerfile
    # Use host networking so the container can reach PostgreSQL and Redis
    # on localhost. This means PORT binds directly on the host (no port mapping).
    network_mode: host
    environment:
      PROJECT_ID: explo-dev
      # PostgreSQL backend
      DATABASE_BACKEND: postgresql
      DATABASE_URL: postgresql://test:test@localhost:5432/netskrafl_test
      # Redis on host
      REDISHOST: "127.0.0.1"
      REDISPORT: "6379"
      # Not "local" in the dev-server sense; gunicorn handles port binding.
      # Setting false avoids the check_port_available() conflict and uses
      # the Docker/container logging path in main.py.
      RUNNING_LOCAL: "false"
      # Work around known gRPC DNS resolution bug in Docker/local environments.
      # Must be set before any gRPC library is imported by Python.
      GRPC_DNS_RESOLVER: native
      # Version tag
      APP_VERSION: docker-local
      # Credentials (mounted below)
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials/service-account.json
      # Listen port (use 3001 to avoid conflicts with other local services)
      PORT: "3001"
    volumes:
      - "./resources/Explo Development-414318fa79b8.json:/app/credentials/service-account.json:ro"
    restart: "no"
