# docker-compose.yml - Local development environment for Netskrafl/Explo
#
# Usage:
#   docker-compose up              # Start app + Redis
#   docker-compose up -d           # Start in background
#   docker-compose up --scale app=3  # Run 3 app instances (with nginx)
#   docker-compose logs -f app     # Follow app logs
#   docker-compose down            # Stop and remove containers
#
# Prerequisites:
#   1. DAWG files must exist: python utils/dawgbuilder.py all
#   2. GCP credentials file at ./credentials/service-account.json
#      (or set GOOGLE_CREDENTIALS_BASE64 environment variable)

version: "3.7"

services:

  # ===========================================================================
  # Main application
  # ===========================================================================
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      # Project ID (change to explo-dev for Explo testing)
      - PROJECT_ID=netskrafl
      # Redis connection (uses service name as hostname)
      - REDIS_URL=redis://redis:6379
      # Not "local" in the GAE sense - use production-like settings
      - RUNNING_LOCAL=false
      # Version string for cache busting
      - APP_VERSION=docker-dev
      # Credentials: either mount file or pass base64-encoded
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
      # Uncomment to use base64 credentials instead of mounted file:
      # - GOOGLE_CREDENTIALS_BASE64=${GOOGLE_CREDENTIALS_BASE64}
    volumes:
      # Mount credentials directory (create ./credentials/service-account.json)
      - ./credentials:/app/credentials:ro
      # Optional: mount source for development (requires restart to pick up changes)
      # - ./src:/app/src:ro
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/live"]
      interval: 30s
      timeout: 10s
      start_period: 90s
      retries: 3

  # ===========================================================================
  # Redis cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    # Uncomment to expose Redis for debugging (may conflict with local Redis)
    # ports:
    #   - "6379:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Nginx load balancer (optional, for scaled deployments)
  # Uncomment this section and the nginx.conf volume to use
  # ===========================================================================
  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #   depends_on:
  #     - app
  #   profiles:
  #     - scaled  # Only start with: docker-compose --profile scaled up

volumes:
  redis-data:
    driver: local

# Networks are created automatically by docker-compose
# All services can reach each other by service name (app, redis, nginx)
